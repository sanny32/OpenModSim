Name:           @PACKAGE_NAME@
Version:        @APP_VERSION@
Release:        1%{?dist}
Summary:        An Open Source Modbus Slave (Server) Utility
Group:          Applications/Utility
License:        MIT
URL:            https://github.com/sanny32/OpenModSim
Packager:       Alexandr Ananev <mail@ananev.org>
Source0:        SOURCES/omodsim

%description
Open ModSim is an open source Modbus slave (server) utility for testing and debugging Modbus TCP and RTU clients.

%global _build_id_links none

%prep

%build

%install
%{__mkdir_p} %{buildroot}/opt
%{__cp} -r %{_sourcedir}/omodsim/opt/* %{buildroot}/opt
%{__mkdir_p} %{buildroot}/usr
%{__cp} -r %{_sourcedir}/omodsim/usr/* %{buildroot}/usr

%post
if [ -f /etc/udev/rules.d/99-omodsim.rules ]; then
    rm -f /etc/udev/rules.d/99-omodsim.rules
fi
if [ ! -f /etc/udev/rules.d/99-omodscan.rules ]; then
    printf  "KERNEL==\"ttyS[0-9]*\", GROUP=\"dialout\", MODE=\"0666\"\n"  >> /etc/udev/rules.d/99-omodsim.rules
    printf  "KERNEL==\"ttyUSB[0-9]*\", GROUP=\"dialout\", MODE=\"0666\"\n"  >> /etc/udev/rules.d/99-omodsim.rules
fi
udevadm trigger

ln -sf /opt/OpenModSim/omodsim.sh /usr/bin/omodsim
xdg-desktop-menu forceupdate || true

%postun
if [ -f /etc/udev/rules.d/99-omodsim.rules ]; then
    rm -f /etc/udev/rules.d/99-omodsim.rules
    udevadm trigger
fi

xdg-desktop-menu forceupdate || true
rm -f /usr/bin/omodsim

%files
/opt/OpenModSim
/usr/share/applications
/usr/share/applications/*
/usr/share/icons
/usr/share/icons/*
/usr/share/metainfo
/usr/share/metainfo/*

%caps(cap_net_bind_service=+ep) /opt/OpenModSim/bin/omodsim
